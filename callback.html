<!DOCTYPE html>
<html>
<head>
    <title>Authentication Complete</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/shared.css">
    <style>
        .container { max-width: 500px; margin: 0 auto; padding: 40px 20px; }
        .button-container { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Connecting to Spotify</h1>
        <div class="spinner" id="spinner"></div>
        <p id="status">Completing authentication...</p>

        <div class="button-container" id="button-container" style="display: none;">
            <a href="#" id="continue-button" class="button">Continue to App</a>
            <a href="#" id="switch-account-button" class="button button-alt">Switch Spotify Account</a>
        </div>
    </div>

    <script src="js/spotify-auth.js"></script>
    <script>
        window.onload = async function () {
            // PKCE
            const params = new URLSearchParams(window.location.search);
            const code   = params.get('code');
            const error  = params.get('error');

            const spinner      = document.getElementById('spinner');
            const status       = document.getElementById('status');
            const btnContainer = document.getElementById('button-container');

            if (error) {
                status.innerHTML = `<div class="error">Authentication error: ${error}</div>`;
                spinner.style.display = 'none';
                return;
            }

            if (!code) {
                status.innerHTML = '<div class="error">No authorization code received</div>';
                spinner.style.display = 'none';
                btnContainer.style.display = 'block';
                document.getElementById('continue-button').textContent = 'Try Again';
                document.getElementById('continue-button').href = 'index.html';
                document.getElementById('switch-account-button').style.display = 'none';
                return;
            }

            // Exchange code for access token
            const codeVerifier = localStorage.getItem('spotify_code_verifier');
            if (!codeVerifier) {
                status.innerHTML = '<div class="error">Missing code verifier. Please try logging in again.</div>';
                spinner.style.display = 'none';
                return;
            }

            try {
                status.textContent = 'Exchanging authorization code...';
                
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: CLIENT_ID,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: REDIRECT_URI,
                        code_verifier: codeVerifier,
                    }),
                });

                if (!response.ok) {
                    throw new Error('Token exchange failed');
                }

                const data = await response.json();
                const accessToken = data.access_token;
                const expiresIn = data.expires_in;

                // Store token
                storeToken(accessToken, expiresIn);
                localStorage.removeItem('spotify_code_verifier'); 
                
                status.textContent = 'Authentication successful!';
                spinner.style.display = 'none';

                // Fetch username
                const redirectUri = localStorage.getItem('original_url') || '/';
                const profile = await fetchUserProfile(accessToken);
                if (profile?.display_name) {
                    status.innerHTML = `Connected as <strong>${profile.display_name}</strong>`;
                }

                // Show buttons
                btnContainer.style.display = 'block';
                document.getElementById('continue-button').href = redirectUri;
                document.getElementById('switch-account-button').addEventListener('click', () => {
                    logoutUser(null, () => {
                        localStorage.setItem('force_login', 'true');
                        window.location.href = localStorage.getItem('original_url') || 'index.html';
                    });
                });

            } catch (err) {
                status.innerHTML = `<div class="error">Failed to get access token: ${err.message}</div>`;
                spinner.style.display = 'none';
                console.error('Token exchange error:', err);
            }
        };
    </script>
</body>
</html>